# Debian variant of the Klaus container image.
#
# This file exists because the architect orb (CircleCI) does not support
# --build-arg. It is identical to Dockerfile except VARIANT defaults to "slim".
#
# Keep in sync with Dockerfile.

# Stage 1: Build the Go binary.
FROM golang:1.25.7 AS builder

WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download

COPY . .
ARG VERSION=dev
ARG COMMIT=unknown
ARG DATE=unknown
ARG TARGETOS=linux
ARG TARGETARCH=amd64
RUN CGO_ENABLED=0 GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build -trimpath \
    -ldflags "-w -extldflags '-static' \
    -X 'main.version=${VERSION}' \
    -X 'main.commit=${COMMIT}' \
    -X 'main.date=${DATE}'" \
    -o klaus .

# Stage 2: Minimal runtime with Node.js and Claude CLI (Debian).
ARG VARIANT=slim
FROM node:24-${VARIANT}
ARG VARIANT

# Install ca-certificates (required for TLS).
RUN if [ "$VARIANT" = "alpine" ]; then \
        apk add --no-cache ca-certificates; \
    else \
        apt-get update && \
        apt-get install -y --no-install-recommends ca-certificates && \
        rm -rf /var/lib/apt/lists/*; \
    fi

# Install Claude Code CLI globally.
RUN npm install -g @anthropic-ai/claude-code && \
    npm cache clean --force

# Create a non-root user for running the application.
RUN if [ "$VARIANT" = "alpine" ]; then \
        addgroup -g 1001 klaus && \
        adduser -u 1001 -G klaus -D -s /bin/sh klaus; \
    else \
        groupadd -g 1001 klaus && \
        useradd -u 1001 -g klaus -m -s /bin/sh klaus; \
    fi

# Create workspace directory.
RUN mkdir -p /workspace && chown klaus:klaus /workspace

# Copy the Go binary from the builder stage.
COPY --from=builder /app/klaus /usr/local/bin/klaus

USER klaus
WORKDIR /workspace

ENV PORT=8080
EXPOSE 8080

ENTRYPOINT ["klaus"]
